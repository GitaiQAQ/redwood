name: Release

on: [create]

jobs:
    create_release:
        name: Create release
        runs-on: ubuntu-latest
        outputs:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
        steps:
            - name: Create release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref }}
                  release_name: ${{ github.ref }}
                  draft: false
                  prerelease: true

    build_redwood:
        name: Build Redwood
        needs: create_release
        strategy:
            fail-fast: false
            matrix:
                platform: [ubuntu-latest, macos-11, macos-10.15] #, windows-latest]
        runs-on: ${{ matrix.platform }}
        steps:
            - name: Checkout the repo
              uses: actions/checkout@v2

            - uses: actions/setup-go@v2
              with:
                go-version: '^1.16.7'

            - name: Cache Go vendor packages
              uses: actions/cache@v2
              with:
                  path: ~/go/pkg/mod
                  key: go-mod-${{ env.CACHE_VERSION }}-${{ hashFiles('go.sum') }}
                  restore-keys: |
                    go-mod-${{ env.CACHE_VERSION }}

            - name: Download Go vendor packages
              run:  go mod download

            - name: Get Yarn cache directory path
              id:   yarn-cache-dir-path
              run:  echo "::set-output name=dir::$(yarn cache dir)"

            - name: Build redwood.js
              run: make redwood.js/dist

            - name: Cache redwood.js dependencies
              uses: actions/cache@v2
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: yarn-redwood.js-${{ env.CACHE_VERSION }}-${{ hashFiles('./redwood.js/yarn.lock') }}
                  restore-keys: |
                    yarn-redwood.js-${{ env.CACHE_VERSION }}

            - name: Build redwood
              run:  go build -o ./redwood .
              working-directory: cmd/redwood

            - name: Upload artifacts
              uses: actions/upload-artifact@v2
              with:
                  name: redwood-${{ matrix.platform }}
                  path: cmd/redwood/redwood

            - name: Upload release assets
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create_release.outputs.upload_url }}
                  asset_name: redwood-${{ matrix.platform }}
                  asset_path: ./cmd/redwood/redwood
                  asset_content_type: application/octet-stream

    build_desktop_chat_app:
        name: Build desktop-chat-app
        needs: create_release
        strategy:
            matrix:
                platform: [ubuntu-latest, macos-11, macos-10.15]
                include:
                    - platform: ubuntu-latest
                      app_name: redwood-chat
                      zip_name: redwood-chat-ubuntu.zip
                    - platform: macos-11
                      app_name: RedwoodChat.app
                      zip_name: redwood-chat-macos-11.zip
                    - platform: macos-10.15
                      app_name: RedwoodChat.app
                      zip_name: redwood-chat-macos-10.15.zip


        runs-on: ${{ matrix.platform }}
        steps:
            - name: Checkout the repo
              uses: actions/checkout@v2

            - uses: actions/setup-go@v2
              with:
                go-version: '^1.16.7'

            - name: Cache Go vendor packages
              uses: actions/cache@v2
              with:
                  path: ~/go/pkg/mod
                  key: go-mod-${{ env.CACHE_VERSION }}-${{ hashFiles('demos/desktop-chat-app/go.sum') }}
                  restore-keys: |
                    go-mod-${{ env.CACHE_VERSION }}

            - name: Download Go vendor packages
              run:  go mod download
              working-directory: demos/desktop-chat-app

            - name: Install system dependencies
              run:  sudo apt update && sudo apt install -y libwebkit2gtk-4.0-dev
              if:   ${{ matrix.platform == 'ubuntu-latest' }}

            - name: Get Yarn cache directory path
              id:   yarn-cache-dir-path
              run:  echo "::set-output name=dir::$(yarn cache dir)"

            - name: Cache redwood.js dependencies
              uses: actions/cache@v2
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: yarn-redwood.js-${{ env.CACHE_VERSION }}-${{ hashFiles('./redwood.js/yarn.lock') }}
                  restore-keys: |
                    yarn-redwood.js-${{ env.CACHE_VERSION }}

            - name: Build redwood.js
              run: make redwood.js/dist

            - name: Cache desktop-chat-app/frontend dependencies
              uses: actions/cache@v2
              with:
                  path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  key: yarn-desktop-chat-app-${{ env.CACHE_VERSION }}-${{ hashFiles('./demos/desktop-chat-app/frontend/yarn.lock') }}
                  restore-keys: |
                    yarn-desktop-chat-app-${{ env.CACHE_VERSION }}

            - name: Install desktop-chat-app/frontend dependencies
              run:  yarn install --frozen-lockfile --prefer-offline
              working-directory: demos/desktop-chat-app/frontend

            - name: Build frontend
              run:  yarn build
              working-directory: demos/desktop-chat-app/frontend

            - name: Build desktop-chat-app
              run:  go build -o ./redwood-chat .
              working-directory: demos/desktop-chat-app

            - name: Package macOS app
              run:  mkdir -p ./packaging/RedwoodChat.app/Contents/MacOS && mv ./redwood-chat ./packaging/RedwoodChat.app/Contents/MacOS/ && mv ./packaging/RedwoodChat.app .
              if:   ${{ matrix.platform == 'macos-11' || matrix.platform == 'macos-10.15' }}
              working-directory: demos/desktop-chat-app

            - name: Zip
              uses: papeloto/action-zip@v1
              with:
                  files: demos/desktop-chat-app/${{ matrix.app_name }}
                  dest:  demos/desktop-chat-app/${{ matrix.zip_name }}

            - name: Upload artifacts
              uses: actions/upload-artifact@v2
              with:
                  name: ${{ matrix.zip_name }}
                  path: demos/desktop-chat-app/${{ matrix.zip_name }}

            - name: Upload release assets
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create_release.outputs.upload_url }}
                  asset_name: ${{ matrix.zip_name }}
                  asset_path: demos/desktop-chat-app/${{ matrix.zip_name }}
                  asset_content_type: application/zip
